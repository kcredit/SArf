---
title: "Getting Started with SArf"
author: "Kevin Credit, Kaur Damanpreet, Emma Eccles"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Getting Started with SArf}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7,
  fig.height = 5
)
```

## Introduction

SArf (Spatial Autoregressive Random Forest) provides a comprehensive framework for spatial machine learning with proper uncertainty quantification. This vignette demonstrates how to use SArf for spatial analysis.

## Installation

```{r eval=FALSE}
# Install from GitHub
devtools::install_github("kcredit/SArf")
```

## Load Package and Data

```{r eval=FALSE}
library(SArf)
library(sf)

# Load your spatial data
data <- st_read("your_data.shp")

# Data should be an sf object with:
# - A response variable (outcome)
# - Predictor variables
# - Spatial geometry
```

## Basic Usage

### Run Complete Analysis

```{r eval=FALSE}
results <- SArf(
  formula = outcome ~ predictor1 + predictor2 + predictor3,
  data = data,
  k_neighbors = 20,
  n_folds = 5,
  n_bootstrap = 20
)
```

### View Results

```{r eval=FALSE}
# Print summary
print(results)

# Detailed summary
summary(results)

# Visualize
plot(results, which = "all")
```

## Step-by-Step Workflow

### Step 1: Test for Spatial Autocorrelation

SArf automatically tests whether your outcome variable has spatial structure:

```{r eval=FALSE}
# View Moran's I test
results$moran_test

# Visualize spatial autocorrelation
print(results$moran_plot)
```

**Interpretation:**
- Moran's I near 0: No spatial autocorrelation
- Positive I: Clustering (similar values near each other)
- Negative I: Dispersion (dissimilar values near each other)
- p < 0.05: Significant spatial structure

### Step 2: Spatial Cross-Validation

SArf uses spatial blocking to prevent data leakage:

```{r eval=FALSE}
# CV performance metrics
results$spatial_cv_results$metrics
```

**Metrics:**
- `rmse`: Root mean squared error
- `r2`: Coefficient of determination
- `morans_i`: Moran's I on residuals (should be near 0)

### Step 3: Model Comparison

Compare RF to traditional spatial econometric models:

```{r eval=FALSE}
# View comparison table
results$model_comparison

# Best performing model
best_model <- results$model_comparison[
  which.min(results$model_comparison$RMSE),
]
print(best_model)
```

**Models compared:**
- OLS: Ordinary least squares (no spatial structure)
- SAR: Spatial autoregressive (spatial lag model)
- SEM: Spatial error model
- SAC: Combined spatial lag + error
- RF_Spatial_CV: Random forest with spatial lag

### Step 4: Variable Importance

See which predictors matter most:

```{r eval=FALSE}
# Importance table with CIs
results$variable_importance

# Visualize
print(results$importance_plot)
```

**Key points:**
- Bootstrap confidence intervals show uncertainty
- `spatial_lag` importance indicates neighborhood effects
- Non-overlapping CIs = significantly different importance

### Step 5: Effect Visualization (ALE)

Understand how each predictor affects the outcome:

```{r eval=FALSE}
# View ALE plots
print(results$ale_plots)

# Access raw ALE data
head(results$ale_results)
```

**Interpreting ALE plots:**
- Y-axis: Change in predicted outcome
- X-axis: Predictor value
- Shaded area: 95% confidence interval
- Flat line = No effect
- Steep slope = Strong effect
- Curved line = Non-linear relationship

### Step 6: Spatial Visualization

Explore results spatially:

```{r eval=FALSE}
# Interactive map
results$leaflet_map

# Save to HTML
library(htmlwidgets)
saveWidget(results$leaflet_map, "results_map.html")
```

## Advanced Options

### Custom Spatial Weights

```{r eval=FALSE}
# Fewer neighbors (more local)
results <- SArf(
  formula = y ~ x1 + x2,
  data = data,
  k_neighbors = 8
)

# More neighbors (more regional)
results <- SArf(
  formula = y ~ x1 + x2,
  data = data,
  k_neighbors = 30
)
```

### Adjust Cross-Validation

```{r eval=FALSE}
# More robust (but slower)
results <- SArf(
  formula = y ~ x1 + x2,
  data = data,
  n_folds = 10,         # More folds
  n_bootstrap = 50,     # More iterations
  block_range = 2000    # Larger blocks (meters)
)
```

### Select Comparison Models

```{r eval=FALSE}
# Only compare to SAR
results <- SArf(
  formula = y ~ x1 + x2,
  data = data,
  compare_models = c("SAR")
)
```

### Disable Mapping

```{r eval=FALSE}
# Skip map creation (faster)
results <- SArf(
  formula = y ~ x1 + x2,
  data = data,
  create_map = FALSE
)
```

## Extracting Components

### Get Predictions

```{r eval=FALSE}
# Mean predictions with uncertainty
preds <- results$spatial_cv_results$predictions_summary
head(preds)
# pred_mean, pred_sd, observed

# Add to original data
data$rf_prediction <- preds$pred_mean
data$rf_uncertainty <- preds$pred_sd
```

### Access Models

```{r eval=FALSE}
# All bootstrap models
all_models <- results$spatial_cv_results$models

# Example: Get first model
model_1 <- all_models[[1]]$model
print(model_1)

# Access spatial econometric models
sar_model <- results$model_details$SAR
summary(sar_model)
```

### Export Results

```{r eval=FALSE}
# Save importance table
write.csv(results$variable_importance, "importance.csv")

# Save model comparison
write.csv(results$model_comparison, "model_comparison.csv")

# Save ALE data
write.csv(results$ale_results, "ale_data.csv")

# Save plots
ggsave("importance.png", results$importance_plot)
ggsave("ale_plots.png", results$ale_plots, width = 10, height = 8)
```

## Example: Health Rating Index

This example uses the methodology from Credit et al. (2025):

```{r eval=FALSE}
# Health Rating Index analysis
hri_results <- SArf(
  formula = HRI ~ In22_ED + NoAuto_p + BVBHth_p + POPD + log_dist,
  data = dublin_data,
  k_neighbors = 20,
  n_folds = 5,
  n_bootstrap = 20
)

# Check spatial autocorrelation in HRI
hri_results$moran_test
# Moran's I = 0.78, p < 0.001 (strong spatial clustering)

# Compare to spatial models
hri_results$model_comparison
# RF performs similarly to SAC, better than OLS/SAR/SEM

# Key predictors of health
hri_results$variable_importance
# 1. spatial_lag (neighborhood effects)
# 2. In22_ED (deprivation)
# 3. log_dist (distance to major roads)

# Non-linear relationships
print(hri_results$ale_plots)
# Shows how deprivation has threshold effects
```

## Troubleshooting

### Moran's I Not Significant

If spatial autocorrelation is not significant, spatial methods may not be necessary:

```{r eval=FALSE}
if (results$moran_test$p.value > 0.05) {
  warning("No significant spatial autocorrelation. Consider regular RF.")
  # But SArf still runs and compares models
}
```

### Long Runtime

Reduce computational burden:

```{r eval=FALSE}
# Faster options
results <- SArf(
  formula = y ~ x1 + x2,
  data = data,
  n_folds = 3,          # Fewer folds
  n_bootstrap = 10,     # Fewer iterations
  num_trees = 250,      # Fewer trees
  create_map = FALSE    # Skip mapping
)
```

### Memory Issues

For large datasets:

```{r eval=FALSE}
# Sample data first
library(dplyr)
data_sample <- data %>% slice_sample(n = 2000)

# Run on sample
results <- SArf(
  formula = y ~ x1 + x2,
  data = data_sample
)
```

## Best Practices

1. **Check your data:**
   - Ensure sf object with valid geometries
   - Check for missing values
   - Transform to appropriate CRS

2. **Start with defaults:**
   - 5 folds, 20 bootstrap iterations is usually sufficient
   - Adjust based on dataset size and available time

3. **Interpret carefully:**
   - Look at multiple metrics (RMSE, RÂ², Moran's I)
   - Consider practical significance, not just statistical
   - Check if spatial lag is important (indicates spatial process)

4. **Validate assumptions:**
   - Check residual spatial autocorrelation
   - Compare to simpler models (OLS)
   - Ensure ALE plots make substantive sense

## References

Credit, K., Damanpreet, K., and Eccles, E. (2025). Exploring the transport-health-environment nexus through a new 'Health Rating Index' for Dublin, Ireland. *Proceedings of the 33rd GISRUK Conference*. DOI: 10.5281/zenodo.15183740

## Getting Help

```{r eval=FALSE}
# Package documentation
?SArf

# Function help
?spatial_cv_rf

# Report issues
# https://github.com/kcredit/SArf/issues
```
