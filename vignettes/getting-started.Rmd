---
title: "Getting Started with SArf"
author: "Kevin Credit"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Getting Started with SArf}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval = FALSE
)
```

# Introduction

This vignette demonstrates how to use the SArf package for spatial autoregressive random forest analysis from start to finish.

# Installation

## One-Time Setup

```{r install}
# Install development tools
install.packages("devtools")
install.packages("roxygen2")

# Install SArf dependencies
install.packages(c(
  "ranger", "sf", "spdep", "spatialreg", "blockCV", "ALEPlot",
  "ggplot2", "dplyr", "tidyr", "leaflet", "htmltools"
))

# Install SArf from GitHub
devtools::install_github("YOUR-USERNAME/SArf")

# Or from local directory
setwd("~/path/to/SArf")
devtools::document()
devtools::install()

# IMPORTANT: Restart R session after installation!
```

# Load Libraries

```{r libraries}
library(SArf)
library(sf)
library(dplyr)

# Note: Only load these three to avoid conflicts!
```

# Data Preparation

## Load and Clean Data

```{r load_clean}
# Read spatial data
data <- st_read("path/to/your_data.shp")

# Clean the data
data_clean <- data %>%
  # Remove missing outcome
  filter(!is.na(your_outcome_variable)) %>%
  # Ensure numeric
  mutate(your_outcome_variable = as.numeric(your_outcome_variable)) %>%
  # Remove missing predictors
  filter(complete.cases(predictor1, predictor2, predictor3)) %>%
  # Fix invalid geometries
  filter(st_is_valid(.))

# Fix duplicate coordinates (IMPORTANT!)
st_geometry(data_clean) <- st_jitter(st_geometry(data_clean), amount = 0.00001)

# Transform to projected CRS (required for spatial blocking)
data_clean <- st_transform(data_clean, 3857)

# Check data
cat("Cleaned data:", nrow(data_clean), "rows\n")
summary(data_clean$your_outcome_variable)
cat("Any NAs?", sum(is.na(data_clean$your_outcome_variable)), "\n")
```

## Choose Parameters Based on Dataset Size

```{r size_params}
n_rows <- nrow(data_clean)
cat("Dataset size:", n_rows, "rows\n")

if (n_rows < 1000) {
  n_folds <- 5
  n_bootstrap <- 20
  num_trees <- 500
  cat("Using full analysis parameters\n")
} else if (n_rows < 3000) {
  n_folds <- 5
  n_bootstrap <- 10
  num_trees <- 500
  cat("Using moderate parameters\n")
} else {
  cat("Large dataset. Sampling 3000 rows...\n")
  set.seed(1111)
  data_clean <- slice_sample(data_clean, n = 3000)
  n_folds <- 3
  n_bootstrap <- 5
  num_trees <- 250
}
```

## Calculate Block Range

```{r block_range}
# Get bounding box
bbox <- st_bbox(data_clean)

# Calculate dimensions
width <- bbox["xmax"] - bbox["xmin"]
height <- bbox["ymax"] - bbox["ymin"]

# Use 1/3 of smaller dimension
block_range <- min(width, height) / 3

cat("Suggested block_range:", round(block_range), "meters\n")

# Rough guides:
# Neighbourhood: 500-1000m
# City: 5000-10000m
# County: 12500-25000m
# Region: 50000-100000m
```

# Run SArf Analysis

```{r run_sarf}
results <- SArf(
  formula = outcome ~ predictor1 + predictor2 + predictor3,
  data = data_clean,
  k_neighbors = 10,
  n_folds = n_folds,
  n_bootstrap = n_bootstrap,
  num_trees = num_trees,
  create_map = TRUE,
  block_range = block_range,
  verbose = TRUE
)
```

# View Results

```{r view_results}
# Print summary
print(results)

# Detailed summary
summary(results)

# Specific outputs
results$moran_test
results$moran_plot
results$model_comparison
results$variable_importance
results$importance_plot
results$ale_results
results$ale_plots
results$leaflet_map
```

# Access Spatial Models

```{r access_models}
# Access fitted models
summary(results$ols_model)
summary(results$sar_model)
summary(results$sem_model)
summary(results$sac_model)

# Get coefficients
coef(results$sar_model)

# Get spatial parameters
results$sar_model$rho
results$sem_model$lambda
```

# Save Outputs

```{r save}
# Create output directory
dir.create("output", showWarnings = FALSE)

# Save plots
ggsave("output/moran_plot.png", results$moran_plot, width = 6, height = 5)
ggsave("output/importance_plot.png", results$importance_plot, width = 8, height = 6)
ggsave("output/ale_plots.png", results$ale_plots, width = 10, height = 8)

# Save tables
write.csv(results$model_comparison, "output/model_comparison.csv", row.names = FALSE)
write.csv(results$variable_importance, "output/variable_importance.csv", row.names = FALSE)
write.csv(results$ale_results, "output/ale_data.csv", row.names = FALSE)

# Save map
library(htmlwidgets)
saveWidget(results$leaflet_map, "output/results_map.html")

cat("\nAll outputs saved!\n")
```

# Real Example: Health Rating Index for Dublin

```{r dublin_example}
# Load Dublin health data
data <- st_read("SA2022_Dublin_AllData.shp") %>%
  filter(!is.na(HRI_gaus_n)) %>%
  mutate(HRI_gaus_n = as.numeric(HRI_gaus_n)) %>%
  filter(complete.cases(HRI_gaus_n, In22_ED, NoAuto_p, POPD, log_dist, ov60, nonIrish)) %>%
  filter(st_is_valid(.))

# Prepare data
st_geometry(data) <- st_jitter(st_geometry(data), amount = 0.00001)
data <- st_transform(data, 3857)

# Calculate block range for Dublin (~20km)
bbox <- st_bbox(data)
block_range <- min(bbox["xmax"] - bbox["xmin"], 
                   bbox["ymax"] - bbox["ymin"]) / 3

# Run analysis
results <- SArf(
  HRI_gaus_n ~ In22_ED + NoAuto_p + POPD + log_dist + ov60 + nonIrish,
  data = data,
  k_neighbors = 10,
  n_folds = 3,
  n_bootstrap = 5,
  num_trees = 250,
  block_range = block_range,
  verbose = TRUE
)

# View results
print(results)
results$model_comparison
results$importance_plot
results$ale_plots
```

# Interpretation Guide

## Model Comparison

- **RMSE**: Lower is better
- **R²**: Higher is better (0-1 scale)
- **Moran's I**: Close to 0 indicates no spatial autocorrelation in residuals
- **Typically**: RF > spatial models for R², spatial models remove autocorrelation

## Variable Importance

- High mean = strong predictor
- Narrow CI = consistent across folds
- spatial_lag often important (neighborhood effects)

## ALE Plots

- Positive slope = positive effect
- Negative slope = negative effect
- Curves = non-linear relationships
- Confidence bands = uncertainty

# Tips and Best Practices

**Dataset Size:**
- < 1000: Full parameters
- 1000-3000: Moderate parameters
- 3000: Sample or reduce parameters

**Block Range:**
- Too small → "same area" error
- Too large → empty folds
- Start with min(width, height) / 3

**Performance:**
- 500 obs: ~5 min
- 1000 obs: ~10 min
- 2000 obs: ~20 min
- 3000 obs: ~45 min

**Avoid Conflicts:**
- Only load: SArf, sf, dplyr
- Don't load ranger, spdep, etc. directly

# Troubleshooting

**"All points from same area"**
- Increase block_range
- Reduce n_folds

**Moran's I shows NA**
- Check for missing values
- Ensure no duplicate coordinates

**Very slow**
- Sample to 2000-3000 rows
- Reduce n_bootstrap to 3-5

# Citation

```
Credit, K. (2025). SArf: Spatial Autoregressive 
Random Forest. https://github.com/kcredit/SArf

Credit, K., Kumar, D., & Eccles, E. (2025). Exploring the 
transport-health-environment nexus through a new 'Health Rating Index'. 
Proceedings of the 33rd GISRUK Conference. DOI: 10.5281/zenodo.15183740
```

# Session Info

```{r sessioninfo}
sessionInfo()
```
